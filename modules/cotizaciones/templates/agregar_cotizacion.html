<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Agregar Cotización</title>
    <link
      rel="stylesheet"
      href="{{url_for('cotizaciones.static', filename='agregar_cotizaciones.css')}}"
    />
  </head>

  <body>
    {% extends "dashboar.html" %} {% block content %}
    <div class="container-wrapper">
      <h2>Agregar Cotización</h2>
      <div class="content-for">
        <form method="POST">
          <div class="form-layout">
            <!-- Columna Izquierda -->
            <div class="left-column">
              <div class="content_campos">
                <div>
                  <label for="numero_cot" class="text"
                    >Número de Cotización</label
                  >
                  <input
                    type="text"
                    name="numero_cot"
                    value="{{ numero_cot }}"
                    class="campo_id"
                    readonly
                  />
                </div>

                <div>
                  <label for="nombre_cliente" class="text"
                    >Nombre del Cliente</label
                  >

                  <input
                    list="lista_familiares"
                    name="nombre_cliente"
                    id="nombre_cliente"
                    class="campo_nombre"
                    required
                  />

                  <datalist id="lista_familiares">
                    {% for familiar in familiares %}
                    <option
                      value="{{ familiar['f_nombre'] }} {{ familiar['f_apellido'] }}"
                    ></option>
                    {% endfor %}
                  </datalist>
                </div>
              </div>

              <!-- Campos de contacto (se muestran solo para clientes manuales) -->
              <div
                class="content_campos"
                id="contact_fields_container"
                style="display: none"
              >
                <div>
                  <label for="cliente_correo" class="text"
                    >Correo Electrónico</label
                  >
                  <input
                    type="email"
                    name="cliente_correo"
                    id="cliente_correo"
                    class="campo_nombre"
                    placeholder="Ingresa el correo del cliente"
                  />
                </div>

                <div>
                  <label for="cliente_telefono" class="text"
                    >Número de Teléfono</label
                  >
                  <div style="display: flex; gap: 8px">
                    <input
                      type="text"
                      name="codigo_pais"
                      id="codigo_pais_cotizacion"
                      value="+51"
                      list="codigos-populares-cotizacion"
                      placeholder="+51"
                      style="
                        width: 80px;
                        padding: 8px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                      "
                    />
                    <datalist id="codigos-populares-cotizacion">
                      <option value="+51">Perú</option>
                      <option value="+58">Venezuela</option>
                      <option value="+57">Colombia</option>
                      <option value="+54">Argentina</option>
                      <option value="+56">Chile</option>
                      <option value="+52">México</option>
                      <option value="+34">España</option>
                      <option value="+1">EE.UU / Canadá</option>
                      <option value="+55">Brasil</option>
                      <option value="+591">Bolivia</option>
                      <option value="+593">Ecuador</option>
                      <option value="+595">Paraguay</option>
                      <option value="+598">Uruguay</option>
                    </datalist>
                    <input
                      type="tel"
                      name="cliente_telefono"
                      id="cliente_telefono"
                      class="campo_nombre"
                      placeholder="912 345 678"
                      pattern="[0-9\s]{7,15}"
                      title="Solo números y espacios"
                      style="flex: 1"
                    />
                  </div>
                </div>
              </div>

              <div>
                <label for="plan_cremacion" class="text"
                  >Plan de cremación</label
                >
                <select
                  name="plan_cremacion"
                  id="plan_cremacion"
                  class="campo_plan"
                >
                  <option value="">Elije un plan de cremación</option>
                  {% for plan in planes %}
                  <option
                    value="{{ plan['id_plan'] }}"
                    data-precio="{{ plan['precio_plan'] }}"
                  >
                    {{ plan['tipo_plan'] }} S/. {{ plan['precio_plan'] }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="fecha_cot" class="text">Fecha de Cotización </label>
                <input
                  type="date"
                  name="fecha_cot"
                  class="campo_fecha"
                  id="fecha_cot"
                  required
                />
              </div>
              <input type="hidden" name="estado_cot" value="1" />
              <input type="hidden" name="validacion_cot" value="Aprobada" />
            </div>

            <!-- Columna Derecha -->
            <div class="right-column">
              <div>
                <label for="servicios_adicionales" class="text"
                  >Servicios adicionales</label
                >
                <div class="content_servicios">
                  {% for servicio in servicios %}
                  <label class="servicio_card">
                    <input
                      type="checkbox"
                      name="servicio_adicional"
                      class="servicio"
                      value="{{ servicio['id_servicio'] }}"
                      data-precio="{{ servicio['precio_serv'] }}"
                    />
                    <span class="checkmark"></span>
                    <span class="servicio_text">
                      {{ servicio['tipo_serv'] }} <br />
                      <small>S/. {{ servicio['precio_serv'] }}</small>
                    </span>
                    <input
                      type="number"
                      name="cantidad_{{ servicio['id_servicio'] }}"
                      class="cantidad-input"
                      value="1"
                      min="1"
                    />
                  </label>
                  {% endfor %}
                </div>
              </div>

              <div class="total-container">
                <p class="text">Total:</p>
                <p class="text">S/. <span id="total">0.00</span></p>
                <input type="hidden" name="monto_cot" id="monto_cot" />
              </div>
            </div>
          </div>

          <div class="content_boton">
            <a
              href="{{ url_for('cotizaciones.listar') }}"
              class="butom_cancelar"
              >Cancelar</a
            >
            <button type="submit" class="butom_agregar">Agregar</button>
          </div>
        </form>
      </div>
    </div>

    <script id="familiares-data" type="application/json">
      [
        {% for familiar in familiares %}
          {
            "nombre": "{{ familiar['f_nombre'] }}",
            "apellido": "{{ familiar['f_apellido'] }}",
            "correo": "{{ familiar['f_correo'] if familiar['f_correo'] else '' }}",
            "telefono": "{{ familiar['f_telefono'] if familiar['f_telefono'] else '' }}"
          }{{ "," if not loop.last }}
        {% endfor %}
      ]
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Crear un mapa de familiares registrados
        const familiaresMap = new Map();
        const familiaresData = JSON.parse(
          document.getElementById('familiares-data').textContent
        );

        familiaresData.forEach((familiar) => {
          const nombreCompleto = `${familiar.nombre} ${familiar.apellido}`
            .toLowerCase()
            .trim();
          familiaresMap.set(nombreCompleto, {
            correo: familiar.correo,
            telefono: familiar.telefono,
          });
        });

        const nombreClienteInput = document.getElementById('nombre_cliente');
        const contactFieldsContainer = document.getElementById(
          'contact_fields_container'
        );
        const correoInput = document.getElementById('cliente_correo');
        const telefonoInput = document.getElementById('cliente_telefono');

        function checkClientType() {
          const nombreIngresado = nombreClienteInput.value.toLowerCase().trim();

          if (familiaresMap.has(nombreIngresado)) {
            // Es un familiar registrado - ocultar campos y limpiarlos
            contactFieldsContainer.style.display = 'none';
            correoInput.value = '';
            telefonoInput.value = '';
          } else if (nombreIngresado.length > 0) {
            // Es un cliente manual - mostrar campos
            contactFieldsContainer.style.display = 'block';
          } else {
            // Campo vacío - ocultar campos
            contactFieldsContainer.style.display = 'none';
          }
        }

        // Detectar cambios en el input de nombre
        nombreClienteInput.addEventListener('input', checkClientType);
        nombreClienteInput.addEventListener('change', checkClientType);

        // Cálculo de total
        const planSelect = document.getElementById('plan_cremacion');
        const servicioCheckboxes = Array.from(
          document.querySelectorAll('input[type="checkbox"].servicio')
        );
        const totalSpan = document.getElementById('total');
        const montoHidden = document.getElementById('monto_cot');

        function toNumber(v) {
          if (!v && v !== 0) return 0;
          v = String(v).trim().replace(',', '.');
          const n = parseFloat(v);
          return isNaN(n) ? 0 : n;
        }

        function calcularTotal() {
          let total = 0;

          if (
            planSelect &&
            planSelect.selectedOptions &&
            planSelect.selectedOptions.length > 0
          ) {
            total += toNumber(planSelect.selectedOptions[0].dataset.precio);
          }

          servicioCheckboxes.forEach((cb) => {
            const cantidadInput = document.querySelector(
              `input[name="cantidad_${cb.value}"]`
            );
            if (cb.checked) {
              const precio = toNumber(cb.dataset.precio || cb.value);
              const cantidad = cantidadInput
                ? toNumber(cantidadInput.value)
                : 1;
              total += precio * cantidad;
            }
          });

          totalSpan.textContent = total.toFixed(2);
          if (montoHidden) montoHidden.value = total.toFixed(2);
        }

        if (planSelect) planSelect.addEventListener('change', calcularTotal);
        servicioCheckboxes.forEach((cb) =>
          cb.addEventListener('change', calcularTotal)
        );
        document.querySelectorAll('.cantidad-input').forEach((input) => {
          input.addEventListener('input', calcularTotal);
        });

        calcularTotal();

        // Validación del código de país
        const codigoPais = document.getElementById('codigo_pais_cotizacion');
        if (codigoPais) {
          // Al perder foco, si está vacío o no tiene +, poner +51
          codigoPais.addEventListener('blur', function () {
            if (!this.value.trim() || !this.value.startsWith('+')) {
              this.value = '+51';
            }
          });

          // Mientras escribe, forzar que empiece con +
          codigoPais.addEventListener('input', function () {
            let val = this.value.trim();
            if (val && !val.startsWith('+')) {
              this.value = '+' + val.replace(/[^\d+]/g, '');
            }
          });
        }
      });

      document.getElementById('fecha_cot').value = new Date()
        .toISOString()
        .split('T')[0];
    </script>

    {% endblock %}
  </body>
</html>
