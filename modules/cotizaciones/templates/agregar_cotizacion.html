<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Agregar Cotización</title>
    <link
      rel="stylesheet"
      href="{{url_for('cotizacion.static', filename='agregar_cotizaciones.css')}}"
    />
  </head>

  <body>
    {% extends "dashboar.html" %} {% block content %}
    <div class="container-wrapper">
      <h2>Agregar Cotización</h2>
      <div class="content-for">
        <form method="POST">
          <div class="form-layout">
            <!-- Columna Izquierda -->
            <div class="left-column">
              <div class="content_campos">
                <div>
                  <label for="numero_cot" class="text"
                    >Número de Cotización</label
                  >
                  <input
                    type="text"
                    name="numero_cot"
                    value="{{ numero_cot }}"
                    class="campo_id"
                    readonly
                  />
                </div>

                <div>
                  <label for="nombre_cliente" class="text"
                    >Nombre del Cliente</label
                  >
                  <select name="nombre_cliente" class="campo_nombre" required>
                    <option value="">Elije un familiar</option>
                    {% for familiar in familiares %}
                    <option value="{{ familiar['id_familiar'] }}">
                      {{ familiar['f_nombre'] }} {{ familiar['f_apellido'] }}
                    </option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <div>
                <label for="plan_cremacion" class="text"
                  >Plan de cremación</label
                >
                <select
                  name="plan_cremacion"
                  id="plan_cremacion"
                  class="campo_plan"
                >
                  <option value="">Elije un plan de cremación</option>
                  {% for plan in planes %}
                  <option
                    value="{{ plan['id_plan'] }}"
                    data-precio="{{ plan['precio_plan'] }}"
                  >
                    {{ plan['tipo_plan'] }} S/. {{ plan['precio_plan'] }}
                  </option>
                  {% endfor %}
                </select>
              </div>

              <div class="content_campos">
                <div>
                  <label for="fecha_cot" class="text"
                    >Fecha de Cotización
                  </label>
                  <input
                    type="date"
                    name="fecha_cot"
                    class="campo_fecha"
                    required
                  />
                </div>
                <div>
                  <label for="validacion_cot" class="text">Validación</label>
                  <select
                    name="validacion_cot"
                    class="campo_validacion"
                    required
                  >
                    <option value="Aprobada">Aprobada</option>
                    <option value="Rechazada">Rechazada</option>
                  </select>
                </div>
              </div>

              <div>
                <label for="estado_cot" class="text">Estado</label>
                <select name="estado_cot" class="campo_estado" required>
                  <option value="1">Activo</option>
                  <option value="0">Inactivo</option>
                </select>
              </div>
            </div>

            <!-- Columna Derecha -->
            <div class="right-column">
              <div>
                <label for="servicios_adicionales" class="text"
                  >Servicios adicionales</label
                >
                <div class="content_servicios">
                  {% for servicio in servicios %}
                  <label class="servicio_card">
                    <input
                      type="checkbox"
                      name="servicio_adicional"
                      class="servicio"
                      value="{{ servicio['id_servicio'] }}"
                      data-precio="{{ servicio['precio_serv'] }}"
                    />
                    <span class="checkmark"></span>
                    <span class="servicio_text">
                      {{ servicio['tipo_serv'] }} <br />
                      <small>S/. {{ servicio['precio_serv'] }}</small>
                    </span>
                    <input
                      type="number"
                      name="cantidad_{{ servicio['id_servicio'] }}"
                      class="cantidad-input"
                      value="1"
                      min="1"
                    />
                  </label>
                  {% endfor %}
                </div>
              </div>

              <div class="total-container">
                <p class="text">Total:</p>
                <p class="text">S/. <span id="total">0.00</span></p>
                <input type="hidden" name="monto_cot" id="monto_cot" />
              </div>
            </div>
          </div>

          <div class="content_boton">
            <a href="{{ url_for('cotizacion.listar') }}" class="butom_cancelar"
              >Cancelar</a
            >
            <button type="submit" class="butom_agregar">Agregar</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const planSelect = document.getElementById('plan_cremacion');
        const servicioCheckboxes = Array.from(
          document.querySelectorAll('input[type="checkbox"].servicio')
        );
        const totalSpan = document.getElementById('total');
        const montoHidden = document.getElementById('monto_cot');

        function toNumber(v) {
          if (!v && v !== 0) return 0;
          v = String(v).trim().replace(',', '.');
          const n = parseFloat(v);
          return isNaN(n) ? 0 : n;
        }

        function calcularTotal() {
          let total = 0;

          if (
            planSelect &&
            planSelect.selectedOptions &&
            planSelect.selectedOptions.length > 0
          ) {
            total += toNumber(planSelect.selectedOptions[0].dataset.precio);
          }

          servicioCheckboxes.forEach((cb) => {
            const cantidadInput = document.querySelector(
              `input[name="cantidad_${cb.value}"]`
            );
            if (cb.checked) {
              const precio = toNumber(cb.dataset.precio || cb.value);
              const cantidad = cantidadInput
                ? toNumber(cantidadInput.value)
                : 1;
              total += precio * cantidad;
            }
          });

          totalSpan.textContent = total.toFixed(2);
          if (montoHidden) montoHidden.value = total.toFixed(2);
        }

        if (planSelect) planSelect.addEventListener('change', calcularTotal);
        servicioCheckboxes.forEach((cb) =>
          cb.addEventListener('change', calcularTotal)
        );
        document.querySelectorAll('.cantidad-input').forEach((input) => {
          input.addEventListener('input', calcularTotal);
        });

        calcularTotal();
      });
    </script>

    {% endblock %}
  </body>
</html>
