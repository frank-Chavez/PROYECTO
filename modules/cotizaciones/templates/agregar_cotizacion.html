<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agregar Cotización</title>
  <link rel="stylesheet" href="{{url_for('cotizacion.static', filename='agregar_cotizaciones.css')}}">
</head>
<body>
  {% extends "dashboar.html" %}
  {% block content %}
  <div>
    <h2>Agregar Cotización</h2>
    <div class="content-for">
      <form method="POST">

        <div class="content_campos">
          <div>
            <label for="numero_cot" class="text">Número de Cotización</label>
            <input type="text" name="numero_cot" value="{{ numero_cot }}" class="campo_id" readonly>
          </div>

          <div>
            <label for="nombre_cliente" class="text">Nombre del Cliente</label>
            <select name="nombre_cliente" class="campo_nombre" required>
              <option value="">Elije un familiar</option>
                {% for familiar in familiares %}
                  <option value="{{ familiar['id_familiar'] }}">
                    {{ familiar['f_nombre'] }} {{ familiar['f_apellido'] }}
                  </option>
                {% endfor %}
            </select>
          </div>
        </div>

        <br>

        <div class="content_campos">
          <div>
            <label for="plan_cremacion" class="text">Plan de cremación</label>
            <select name="plan_cremacion" id="plan_cremacion" class="campo_plan" required>
              <option value="">Elije un plan de cremación</option>
                {% for plan in planes %}
                  <option value="{{ plan['id_plan'] }}" data-precio="{{ plan['precio_plan'] }}">
                    {{ plan['tipo_plan'] }} S/. {{ plan['precio_plan'] }}
                  </option>
                {% endfor %}
            </select>
          </div>
        <div>
          <label for="servicios_adicionales" class="text">Servicios adicionales</label>
          <div class="content_servicios">
            {% for servicio in servicios %}
              <label class="servicio_card">
                <input 
                  type="checkbox"
                  name="servicio_adicional"
                  class="servicio"
                  value="{{ servicio['id_servicio'] }}"
                  data-precio="{{ servicio['precio_serv'] }}">
                <span class="checkmark"></span>
                <span class="servicio_text">
                  {{ servicio['tipo_serv'] }} <br>
                  <small>S/. {{ servicio['precio_serv'] }}</small>
                </span>
              </label>
            {% endfor %}
          </div>
        </div>
  
        </div>

        <br>

        <div class="content_campos">
          <div>
            <label for="fecha_cot" class="text">Fecha de Cotización</label>
            <input type="date" name="fecha_cot" class="campo_fecha" required>
          </div>
          <div>
            <label for="validacion_cot" class="text">Validación</label>
            <select name="validacion_cot" class="campo_validacion" required>
              <option value="Aprobada">Aprobada</option>
              <option value="Rechazada">Rechazada</option>
            </select>
          </div>
        </div>

        <div class="content_campos">
          <div>
            <label for="estado_cot" class="text">Estado</label>
            <select name="estado_cot" class="campo_estado" required>
              <option value="1">Activo</option>
              <option value="0">Inactivo</option>
            </select>
          </div>
          <div>
            <p class="text">Total:<br> S/. <span id="total">0.00</span></p>
            <input type="hidden" name="monto_cot" id="monto_cot">
          </div>
        </div>

        <div class="content_boton">
          <a href="{{ url_for('cotizacion.listar') }}" class="butom_cancelar">Cancelar</a>
          <button type="submit" class="butom_agregar">Agregar</button>
        </div>
        
      </form>
    </div>
  </div>

  <!-- SCRIPT: se ejecuta después de que cargue el DOM -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const planSelect = document.getElementById('plan_cremacion');
      const servicioCheckboxes = Array.from(document.querySelectorAll('input[type="checkbox"].servicio'));
      const totalSpan = document.getElementById('total');
      const montoHidden = document.getElementById('monto_cot');

      // función segura para convertir a número
      function toNumber(v) {
        if (!v && v !== 0) return 0;
        v = String(v).trim().replace(',', '.');
        const n = parseFloat(v);
        return isNaN(n) ? 0 : n;
      }

      function calcularTotal() {
        let total = 0;

        // precio del plan (dataset.precio)
        if (planSelect && planSelect.selectedOptions && planSelect.selectedOptions.length > 0) {
          total += toNumber(planSelect.selectedOptions[0].dataset.precio);
        }

        // sumar servicios marcados
        servicioCheckboxes.forEach(cb => {
          if (cb.checked) {
            // dataset.precio es preferible; si no existe, intenta con value (no ideal)
            total += toNumber(cb.dataset.precio || cb.value);
          }
        });

        // mostrar y guardar
        totalSpan.textContent = total.toFixed(2);
        if (montoHidden) montoHidden.value = total.toFixed(2);

        // debug en consola (borra si quieres)
        console.log('calcularTotal -> planPrecio:', planSelect.selectedOptions[0]?.dataset?.precio, 'total:', total);
      }

      // debug inicial: muestro cuantos checkbox y si el select existe
      console.log('DEBUG: planSelect encontrado?', !!planSelect, 'check servicios:', servicioCheckboxes.length);

      // ligar eventos
      if (planSelect) planSelect.addEventListener('change', calcularTotal);
      servicioCheckboxes.forEach(cb => cb.addEventListener('change', calcularTotal));

      // calcular al cargar la página (por si hay selección por defecto)
      calcularTotal();
    });
  </script>

  {% endblock %}
</body>
</html>
