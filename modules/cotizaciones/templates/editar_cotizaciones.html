<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{url_for('cotizacion.static', filename='editar_cotizaciones.css')}}">
</head>
<body>
    {% extends "dashboar.html" %}
    {% block content %}
    <h2>{{ title }}</h2>
    <div class="content">
        <section class="content-for">
            <h5>Datos de la cotizacion</h5>
            <form id="form-cotizacion" class="formulario" method="POST">

                <label for="numero_cot" class="text">Número de Cotización:</label><br>
                <input type="text" name="numero_cot" value="{{ cot['numero_cot'] }}" class="campo_id" required readonly><br><br>
        
                <label for="nombre_cliente" class="text">Nombre del Cliente:</label><br>
                <select name="nombre_cliente"  class="campo_name" required>
                    <option value="">Elige un familiar</option>
                    {% for f in familiares_disponibles %}
                        <option value="{{ f['id_familiar'] }}"
                            {% if familiares and f['id_familiar'] == familiares[0]['id_familiar'] %}selected{% endif %}>
                            {{ f['f_nombre'] }} {{ f['f_apellido'] }}
                        </option>
                    {% endfor %}
                </select>
                <br><br>
        
                <label for="plan_cremacion" class="text">Plan de Cremación:</label><br>
                <select name="plan_cremacion" id="plan_cremacion" class="campo_plan" required>
                    {% for p in planes_disponibles %}
                        <option value="{{ p['id_plan'] }}" 
                                data-precio="{{ p['precio_plan'] }}"
                                {% if plan and plan['id_plan'] == p['id_plan'] %}selected{% endif %}>
                            {{ p['tipo_plan'] }}
                        </option>
                    {% endfor %}
                </select>
                <br><br>
        
                <label for="servicios_adicionales" class="text">Servicios seleccionados:</label><br>
                {% for s in servicios_disponibles %}
                <label class="campo_servicios">
                    <input type="checkbox" name="servicios_adicionales" value="{{ s['id_servicio'] }}"
                    data-precio="{{ s['precio_serv'] }}"
                    {% for serv in servicios %}
                        {% if serv['id_servicio'] == s['id_servicio'] %}checked{% endif %}
                    {% endfor %}>
                    <span class="checkmark"></span>
                    <span class="nombre">{{ s['tipo_serv'] }}</span>
                    <span class="precio">S/.{{ s['precio_serv'] }}</span>
                </label>
                {% endfor %}

        
                <label for="fecha_cot" class="text">Fecha de Cotización:</label><br>
                <input type="date" name="fecha_cot" value="{{ cot['fecha_cot'] }}" class="campo_fecha" required><br><br>
        
                <label for="monto_cot" class="text">Monto de Cotización:</label><br>
                <input type="number" name="monto_cot" id="monto_cot" value="{{ cot['monto_cot'] }}" step="0.01" class="campo_monto" readonly><br><br>
        
                <label for="validacion_cot" class="text">Validación de Cotización:</label><br>
                <select name="validacion_cot" class="campo_validacion" >
                    <option value="">Elije una validación</option>
                    <option value="Aprobada" {{ 'selected' if cot['validacion_cot'] == 'Aprobada' else '' }}>Aprobada</option>
                    <option value="Rechazada" {{ 'selected' if cot['validacion_cot'] == 'Rechazada' else '' }}>Rechazada</option>
                </select>


                <label for="estado_cot" class="text">Estado:</label><br>
                <select name="estado_cot" class="campo_estado" required>
                    <option value="1" {% if cot['estado_cot'] == 1 %}selected{% endif %}>Activo</option>
                    <option value="0" {% if cot['estado_cot'] == 0 %}selected{% endif %}>Inactivo</option>
                </select>
                <br><br>
        
            </form>
        </section>
        <section class="content_resumen">
            <h5>Resumen de cotización</h5>
            <h6>Ítems seleccionados</h6>
            <div class="items_resumen" id="resumen">
            </div>
            <button type="submit" form="form-cotizacion" class="butom_guardar">Guardar</button>
            <a href="{{ url_for('cotizacion.listar') }}" class="butom_cancelar">Cancelar</a>
        </section>
    </div>    


    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const resumenDiv = document.getElementById("resumen");
        const montoInput = document.getElementById("monto_cot");
        const planSelect = document.querySelector("select[name='plan_cremacion']");
        const serviciosCheckboxes = document.querySelectorAll("input[name='servicios_adicionales']");
        const nombreCliente = document.querySelector("select[name='nombre_cliente']");

        function actualizarMontoYResumen() {
            let total = 0;
            let resumenHTML = "";

           // Plan
            if (planSelect.value) {
                const plan = planSelect.options[planSelect.selectedIndex];
                const precioPlan = parseFloat(plan.dataset.precio || 0);

                total += precioPlan; // solo sumas una vez

                resumenHTML += `
                    <div class="resumen-item">
                        <span class="resumen-label">${plan.text}</span>
                        <span class="">S/. ${precioPlan.toFixed(2)}</span>
                    </div>
                `;
            }



            // Servicios
            let servicios = [];
            serviciosCheckboxes.forEach(chk => {
                if (chk.checked) {
                    total += parseFloat(chk.dataset.precio || 0);
                    const nombre = chk.parentNode.querySelector(".nombre")?.textContent || "";
                    const precio = chk.dataset.precio || "0";
                    servicios.push(`
                    <div class="resumen-item">
                        <span class="">${nombre}</span>
                        <span class="">S/. ${precio}</span>
                    </div>`);
                }
            });
            if (servicios.length > 0) {
                resumenHTML += `${servicios.join("")}</p>`;
            }

            // Total
            montoInput.value = total.toFixed(2);
            resumenHTML += `
            <div class="total">
                <span class="">Total:</span>
                <span class="">S/. ${montoInput.value}</span>
            </div>`;

            // Mostrar en resumen
            resumenDiv.innerHTML = resumenHTML || "<p>No hay selección todavía.</p>";
        }

        // Eventos
        nombreCliente.addEventListener("change", actualizarMontoYResumen);
        planSelect.addEventListener("change", actualizarMontoYResumen);
        serviciosCheckboxes.forEach(chk => chk.addEventListener("change", actualizarMontoYResumen));

        // Inicializar
        actualizarMontoYResumen();
    });
    </script>
    {% endblock %}
</body>
</html>
