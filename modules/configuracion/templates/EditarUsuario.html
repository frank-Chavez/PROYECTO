<!-- templates/EditarUsuario.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ title }}</title>
  <link rel="stylesheet" href="{{ url_for('configuracion.static', filename='permisos.css') }}" />
  <link rel="stylesheet" href="{{ url_for('configuracion.static', filename='seguridad.css') }}" />
  <link rel="stylesheet" href="{{ url_for('configuracion.static', filename='editar.css') }}" />
</head>
<body>
  {% extends "configuracion.html" %}

  {% block options %}
  <div class="editar-usuario-container">
    
    <!-- USER INFO SECTION -->
    <div class="section-card">
      <h2 class="section-title">Información del Usuario</h2>
      <form method="POST" action="{{ url_for('configuracion.editar_usuario', usuario_id=usuario.id_usuario) }}">
        <div class="form-group">
          <label for="nombre" class="form-label">Nombre de usuario</label>
          <input type="text" class="form-control" id="nombre" name="nombre" value="{{ usuario.nombre_u }}" required autocomplete="off" />
        </div>
        <div class="form-group">
          <label for="rol" class="form-label">Rol</label>
          <select class="form-select" id="rol" name="rol" required>
            <option value="2" {% if usuario.rol_id == 2 %}selected{% endif %}>Usuario normal</option>
            <option value="1" {% if usuario.rol_id == 1 %}selected{% endif %}>Administrador</option>
          </select>
        </div>
        <div class="button-group">
          <a href="{{ url_for('configuracion.index') }}" class="btn btn-secondary">Cancelar</a>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>

    <!-- PERMISSIONS SECTION -->
    <div class="section-card">
      <h2 class="section-title">Permisos por Módulo</h2>
      <form method="POST" action="{{ url_for('configuracion.guardar_permisos_modulo') }}">
        <input type="hidden" name="usuario_id" value="{{ usuario.id_usuario }}" />
        
        <div class="table-responsive">
          <table class="table-permisos">
            <thead>
              <tr>
                <th>Módulo</th>
                <th class="text-center">Ver</th>
                <th class="text-center">Crear</th>
                <th class="text-center">Editar</th>
                <th class="text-center">Eliminar</th>
                <th class="text-center">Exportar</th>
              </tr>
            </thead>
            <tbody>
              {% for modulo in modulos %}
              {% set p = permisos.get(modulo.id_modulo, {'ver':0,'crear':0,'editar':0,'eliminar':0,'exportar':0}) %}
              <tr>
                <td class="modulo-name">{{ modulo.nombre_modulo }}</td>
                <td class="text-center">
                  <input type="checkbox" name="modulo_{{ modulo.id_modulo }}_ver" {% if p.ver %}checked{% endif %} {% if usuario.id_usuario == 1 %}disabled{% endif %}>
                </td>
                <td class="text-center">
                  <input type="checkbox" name="modulo_{{ modulo.id_modulo }}_crear" {% if p.crear %}checked{% endif %} {% if usuario.id_usuario == 1 %}disabled{% endif %}>
                </td>
                <td class="text-center">
                  <input type="checkbox" name="modulo_{{ modulo.id_modulo }}_editar" {% if p.editar %}checked{% endif %} {% if usuario.id_usuario == 1 %}disabled{% endif %}>
                </td>
                <td class="text-center">
                  <input type="checkbox" name="modulo_{{ modulo.id_modulo }}_eliminar" {% if p.eliminar %}checked{% endif %} {% if usuario.id_usuario == 1 %}disabled{% endif %}>
                </td>
                <td class="text-center">
                  <input type="checkbox" name="modulo_{{ modulo.id_modulo }}_exportar" {% if p.exportar %}checked{% endif %} {% if usuario.id_usuario == 1 %}disabled{% endif %}>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="button-group">
          {% if usuario.id_usuario != 1 %}
          <button type="submit" class="btn btn-success">Guardar Permisos</button>
          {% else %}
          <button type="button" class="btn btn-secondary" disabled>Administrador Protegido</button>
          {% endif %}
        </div>
      </form>
    </div>

    <!-- SECURITY SECTION -->
    <div class="section-card">
      <h2 class="section-title">Seguridad</h2>
      <form method="POST" action="{{ url_for('configuracion.cambiar_contrasena') }}">
        <input type="hidden" name="usuario_id" value="{{ usuario.id_usuario }}" />
        <div class="security-form-row">
          <div class="security-form-col">
            <label for="nueva" class="form-label">Nueva contraseña (mín. 8 caracteres)</label>
            <div class="password-wrapper">
              <input type="password" class="form-control" id="nueva" name="nueva" required minlength="8" placeholder="••••••••" />
              <span class="toggle-pass" onclick="togglePassword()">
                <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              </span>
            </div>
          </div>
          <div class="security-form-col-auto">
            <button type="submit" class="btn btn-warning">Cambiar Contraseña</button>
          </div>
        </div>
      </form>
    </div>

  </div>
  {% endblock %}

  <script>
    function togglePassword() {
      const input = document.getElementById('nueva');
      const icon = document.getElementById('eye-icon');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
      } else {
        input.type = 'password';
        icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
      }
    }
  </script>
</body>
</html>