<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{title}}</title>
  <link rel="stylesheet" href="{{ url_for('configuracion.static', filename='permisos.css')}}">
</head>
<body>
  {% extends "configuracion.html" %} {% block options %}
    <div class="container-fluid mt-4">
      <h3 class="mb-4 text-center text-primary font-weight-bold">
        Permisos por Módulo
      </h3>



      <div class="accordion" id="accordionUsuarios">
        {% for usuario in usuarios %} {% set uid = usuario.id_usuario %}

        <div class="card mb-4 shadow-sm border-0 rounded-lg overflow-hidden">
          <!-- Cabecera del usuario -->
          <!-- Cabecera del usuario -->
          <div class="card-header bg-gradient-primary text-white p-4">
              <h5 class="mb-0">
                  <button
                      class="btn btn-block text-left text-white font-weight-bold d-flex justify-content-between align-items-center collapsed"
                      type="button"
                      data-toggle="collapse"
                      data-target="#user{{ uid }}"
                      aria-expanded="false"
                  >
                      <span>
                          <strong>{{ usuario.nombre_u }}</strong>

                          <!-- Badge que indica el tipo de usuario -->
                          {% if uid == 1 %}
                              <span class="badge badge-warning text-dark ml-3">ADMINISTRADOR PRINCIPAL</span>
                          {% elif usuario.rol_id == 1 %}
                              <span class="badge badge-danger ml-3">ADMINISTRADOR</span>
                          {% else %}
                              <span class="badge badge-secondary ml-3">USUARIO</span>
                          {% endif %}
                      </span>
                      <i class="fas fa-chevron-down fa-lg"></i>
                  </button>
              </h5>
          </div>

          <!-- Contenido colapsable -->
          <div
            id="user{{ uid }}"
            class="collapse {% if loop.first %}show{% endif %}"
            data-parent="#accordionUsuarios"
          >
            <div class="card-body p-0">
              <form
                method="POST"
                action="{{ url_for('configuracion.guardar_permisos_modulo') }}"
              >
                <input type="hidden" name="usuario_id" value="{{ uid }}" />

                <table class="table table-hover mb-0">
                  <thead class="bg-light">
                    <tr>
                      <th class="pl-4">Módulo</th>
                      <th class="text-center">Ver</th>
                      <th class="text-center">Crear</th>
                      <th class="text-center">Editar</th>
                      <th class="text-center">Eliminar</th>
                      <th class="text-center">Exportar</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for modulo in modulos %}
                    {% set p = permisos.get(uid, {}).get(modulo.id_modulo, {'ver':0,'crear':0,'editar':0,'eliminar':0,'exportar':0}) %}

                    <!-- MÓDULO CONFIGURACIÓN (id = 7) -->
                    {% if modulo.id_modulo == 7 %}
                    <tr class="table-warning">
                        <td class="pl-4 py-3">
                            <strong>Panel de Administración</strong>
                            <small class="text-muted d-block">Acceso completo al módulo de usuarios, permisos y configuración</small>
                        </td>
                        <td colspan="5" class="text-center py-4">
                            <div class="custom-control custom-switch custom-switch-lg">
                                <input type="checkbox"
                                      class="custom-control-input"
                                      id="admin-switch-{{ uid }}"
                                      name="acceso_configuracion"
                                      value="1"
                                      {% if p.ver %}checked{% endif %}   
                                      {% if uid == 1 %}checked disabled{% endif %}>
                                <label class="custom-control-label font-weight-bold {% if p.ver or uid == 1 %}text-success{% else %}text-danger{% endif %}"
                                      for="admin-switch-{{ uid }}">
                                    {% if p.ver or uid == 1 %}Acceso permitido{% else %}Acceso denegado{% endif %}
                                </label>
                            </div>
                        </td>
                    </tr>

                    {% else %}
                    <tr {% if uid == 1 %}class="table-success"{% endif %}>
                        <td class="pl-4 font-weight-medium">
                            {{ modulo.nombre_modulo }}
                        </td>

                        <!-- Ver -->
                        <td class="text-center">
                            <input type="checkbox" name="modulo_{{ modulo.id_modulo }}_ver"
                                  {% if p.ver %}checked{% endif %}
                                  {% if uid == 1 %}disabled{% endif %}>
                        </td>
                        <!-- Crear -->
                        <td class="text-center">
                            <input type="checkbox" name="modulo_{{ modulo.id_modulo }}_crear"
                                  {% if p.crear %}checked{% endif %}
                                  {% if uid == 1 %}disabled{% endif %}>
                        </td>
                        <!-- Editar -->
                        <td class="text-center">
                            <input type="checkbox" name="modulo_{{ modulo.id_modulo }}_editar"
                                  {% if p.editar %}checked{% endif %}
                                  {% if uid == 1 %}disabled{% endif %}>
                        </td>
                        <!-- Eliminar -->
                        <td class="text-center">
                            <input type="checkbox" name="modulo_{{ modulo.id_modulo }}_eliminar"
                                  {% if p.eliminar %}checked{% endif %}
                                  {% if uid == 1 %}disabled{% endif %}>
                        </td>
                        <!-- Exportar -->
                        <td class="text-center">
                            <input type="checkbox" name="modulo_{{ modulo.id_modulo }}_exportar"
                                  {% if p.exportar %}checked{% endif %}
                                  {% if uid == 1 %}disabled{% endif %}>
                        </td>
                    </tr>
                    {% endif %}

                    {% endfor %}
                </tbody>
                </table>

                <!-- Botón guardar -->
                <div class="card-footer bg-white text-right border-top-0">
                  {% if uid != 1 %}
                  <button
                    type="submit"
                    class="btn btn-success btn-lg px-5 shadow-sm"
                  >
                    Guardar Permisos
                  </button>
                  {% else %}
                  <button
                    type="button"
                    class="btn btn-secondary btn-lg px-5"
                    disabled
                  >
                    Administrador Protegido
                  </button>
                  {% endif %}
                </div>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
{% endblock %}
</body>
</html>


